{"version":3,"sources":["commands/build/auth.js"],"names":["creds","spawnAndCollectJSONOutputAsync","FASTLANE","validate_apple_credentials","appleId","password","getTeamsAttempt","DEBUG","console","log","action","dump","result","reason","rawDump","Error","teams","length","NO_TEAM_ID","teamId","teamChoices","map","team","i","forEach","choice","prompt","type","name","message","choices","answers","indexOf","validateCredentialsProduceTeamId","process","platform","match","version","access","WSL_BASH","constants","F_OK","warn","ENABLE_WSL","prepareLocalAuth","program","args","race","resolve","reject","setTimeout","timeout_msg","TIMEOUT","jsonContent","cmd","WSL_ONLY_PATH","windowsToWSLPath","join","child","spawn","opts","e","stdout","on","d","toString","stderr","push","reply","Buffer","concat","JSON","parse","USER_PERMISSIONS_ERROR","createAppOnPortal","ensureAppIdLocally","produceProvisionProfile","producePushCerts","produceCerts","require","NO_BUNDLE_ID","MULTIPLE_PROFILES","env","EXPO_DEBUG","doesFileProvidedExist","printOut","p12Path","stat","stats","isFile","doFastlaneActionsExist","all","path","doesExist","appStoreAction","metadata","bundleIdentifier","experienceName","app_management","credentials","fetch_new_provisioning_profile","fetch_push_cert","fetch_cert","noSlashes","p","slice","MINUTES","prgm","stdio"],"mappings":"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","file":"../../../commands/build/auth.js","sourcesContent":["// Getting an undefined anywhere here probably means a ruby script is throwing an exception\nimport child_process from 'child_process';\nimport slash from 'slash';\nimport spawnAsync from '@expo/spawn-async';\nimport { basename } from 'path';\nimport inquirer from 'inquirer';\nimport fs from 'fs-extra';\nimport { release } from 'os';\n\nimport log from '../../log';\n\nconst FASTLANE =\n  process.platform === 'darwin'\n    ? require('@expo/traveling-fastlane-darwin')()\n    : require('@expo/traveling-fastlane-linux')();\n\nconst WSL_BASH = 'C:\\\\Windows\\\\system32\\\\bash.exe';\n\nconst WSL_ONLY_PATH = 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin';\n\nexport const NO_BUNDLE_ID = 'App could not be found for bundle id';\n\nexport const MULTIPLE_PROFILES = 'Multiple profiles found with the name';\n\nexport const DEBUG = process.env.EXPO_DEBUG && process.env.EXPO_DEBUG === 'true';\n\nconst ENABLE_WSL = `\nDoes not seem like WSL enabled on this machine. Download from the Windows app\nstore a distribution of Linux, then in an admin powershell, please run:\n\nEnable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux\n`;\n\nexport const doesFileProvidedExist = async (printOut, p12Path) => {\n  try {\n    const stats = await fs.stat(p12Path);\n    return stats.isFile();\n  } catch (e) {\n    if (printOut) {\n      console.log('\\nFile does not exist.');\n    }\n    return false;\n  }\n};\n\nexport const doFastlaneActionsExist = async () => {\n  return Promise.all(\n    Object.keys(FASTLANE).map(async action => {\n      let path = FASTLANE[action];\n      return { action, path, doesExist: await doesFileProvidedExist(false, path) };\n    })\n  );\n};\n\nfunction appStoreAction(creds, metadata, teamId, action) {\n  const args = [\n    action,\n    creds.appleId,\n    creds.password,\n    teamId,\n    metadata.bundleIdentifier,\n    metadata.experienceName,\n  ];\n  return spawnAndCollectJSONOutputAsync(FASTLANE.app_management, args);\n}\n\nexport function createAppOnPortal(creds, metadata, teamId) {\n  return appStoreAction(creds, metadata, teamId, 'create');\n}\n\nexport function ensureAppIdLocally(creds, metadata, teamId) {\n  return appStoreAction(creds, metadata, teamId, 'verify');\n}\n\nexport function produceProvisionProfile(credentials, { bundleIdentifier }, teamId) {\n  return spawnAndCollectJSONOutputAsync(FASTLANE.fetch_new_provisioning_profile, [\n    credentials.appleId,\n    credentials.password,\n    bundleIdentifier,\n    teamId,\n  ]);\n}\n\nexport function producePushCerts(credentials, { bundleIdentifier }, teamId) {\n  return spawnAndCollectJSONOutputAsync(FASTLANE.fetch_push_cert, [\n    credentials.appleId,\n    credentials.password,\n    bundleIdentifier,\n    teamId,\n  ]);\n}\n\nexport function produceCerts(credentials, teamId) {\n  return spawnAndCollectJSONOutputAsync(FASTLANE.fetch_cert, [\n    credentials.appleId,\n    credentials.password,\n    teamId,\n  ]);\n}\n\nconst NO_TEAM_ID = `You have no team ID associated with your apple account, cannot proceed.\n(Do you have a paid Apple developer Account?)`;\n\nexport async function validateCredentialsProduceTeamId(creds) {\n  const getTeamsAttempt = await spawnAndCollectJSONOutputAsync(\n    FASTLANE.validate_apple_credentials,\n    [creds.appleId, creds.password]\n  );\n  if (DEBUG) {\n    console.log({ action: 'teams attempt retrieval', dump: getTeamsAttempt });\n  }\n  if (getTeamsAttempt.result === 'failure') {\n    const { reason, rawDump } = getTeamsAttempt;\n    throw new Error(`Reason:${reason}, raw:${JSON.stringify(rawDump)}`);\n  }\n  const { teams } = getTeamsAttempt;\n  if (teams.length === 0) {\n    throw new Error(NO_TEAM_ID);\n  }\n  log(`You have ${teams.length} teams`);\n  if (teams.length === 1) {\n    console.log(`Only 1 team associated with your account, using Team ID: ${teams[0].teamId}`);\n    return { teamId: teams[0].teamId };\n  } else {\n    const teamChoices = teams.map(\n      (team, i) => `${i + 1}) ${team['teamId']} \"${team['name']}\" (${team['type']})`\n    );\n    teamChoices.forEach(choice => console.log(choice));\n    const answers = await inquirer.prompt({\n      type: 'list',\n      name: 'choice',\n      message: `Which Team ID to use?`,\n      choices: teamChoices,\n    });\n    return { teamId: teams[teamChoices.indexOf(answers.choice)].teamId };\n  }\n}\n\nconst windowsToWSLPath = p => {\n  const noSlashes = slash(p);\n  return noSlashes.slice(2, noSlashes.length);\n};\nconst MINUTES = 3;\nconst TIMEOUT = 60 * 1000 * MINUTES;\n\nconst timeout_msg = prgm =>\n  process.platform === 'win32'\n    ? `Took too long (limit is ${MINUTES} minutes) to execute ${prgm}.\nIs your WSL working? in Powershell try: bash.exe -c 'uname'`\n    : `Took too long (limit is ${MINUTES} minutes) to execute ${prgm}`;\n\nconst opts = { stdio: ['inherit', 'pipe', 'pipe'] };\n\nexport async function prepareLocalAuth() {\n  if (process.platform === 'win32') {\n    const [version] = release().match(/\\d./);\n    if (version !== '10') {\n      throw new Error('Must be on at least Windows version 10 for WSL support to work');\n    }\n    // Does bash.exe exist?\n    try {\n      await fs.access(WSL_BASH, fs.constants.F_OK);\n    } catch (e) {\n      log.warn(ENABLE_WSL);\n      throw e;\n    }\n  }\n}\n\nconst USER_PERMISSIONS_ERROR =\n  'You probably do not have user permissions for where exp is installed, consider changing permissions there';\n\nasync function spawnAndCollectJSONOutputAsync(program, args) {\n  return Promise.race([\n    new Promise((resolve, reject) => {\n      setTimeout(() => reject(new Error(timeout_msg(program))), TIMEOUT);\n    }),\n    new Promise((resolve, reject) => {\n      const jsonContent = [];\n      try {\n        if (process.platform === 'win32') {\n          const cmd = [\n            '-c',\n            `${WSL_ONLY_PATH} /mnt/c${windowsToWSLPath(program)} ${args.join(' ')}`,\n          ];\n          var child = child_process.spawn(WSL_BASH, cmd, opts);\n        } else {\n          var child = child_process.spawn(program, args, opts);\n        }\n      } catch (e) {\n        return reject(e);\n      }\n      child.stdout.on('data', d => console.log(d.toString()));\n      // This is where we get our replies back from the ruby code\n      child.stderr.on('data', d => jsonContent.push(d));\n      child.stdout.on('end', () => {\n        const reply = Buffer.concat(jsonContent).toString();\n        try {\n          resolve(JSON.parse(reply));\n        } catch (e) {\n          reject({\n            result: 'failure',\n            reason:\n              reply.match(/Bundler::InstallError/) === null\n                ? 'Could not understand JSON reply from Ruby based local auth scripts'\n                : USER_PERMISSIONS_ERROR,\n            rawDump: reply,\n          });\n        }\n      });\n    }),\n  ]);\n}\n"],"sourceRoot":"/Users/mike/Documents/Work/exp/src"}